# 0011: Test Fixture Dataset Pinning

**Status:** Accepted  
**Date:** 2025-11-15  
**Deciders:** Development Team  
**Technical Story:** Refactor test fixtures to use real EVE Frontier data

## Context and Problem Statement

The original test fixtures used synthetic data with three hardcoded systems (Y:170N, AlphaTest, BetaTest) and synthetic coordinates, jumps, and metadata. While this approach provided fast, reproducible tests, it had several limitations:

1. **Schema Divergence**: Synthetic data didn't fully match the real e6c3 dataset schema, particularly for constellation and region metadata, requiring the loader to handle missing or null fields
2. **Unrealistic Testing**: Tests ran against idealized data that didn't reflect actual EVE Frontier system names, distances, or connectivity patterns
3. **Maintenance Burden**: Any schema changes in the production dataset required manual updates to the synthetic fixture generation script
4. **Limited Coverage**: The 3-system fixture couldn't adequately test spatial routing, multi-hop paths, or edge cases found in real data

We needed a test fixture strategy that balanced realism with speed and reproducibility.

## Decision Drivers

- **Realism**: Tests should exercise the same data structures and patterns found in production datasets
- **Performance**: Test suite should complete quickly; full e6c3 dataset (~10,000+ systems) is too large for unit/integration tests
- **Reproducibility**: Tests should pass consistently across environments and not depend on external network access
- **Schema Compatibility**: Fixture should expose any loader bugs related to schema detection or metadata joins
- **Maintainability**: Updating the fixture when CCP changes the dataset should be straightforward

## Considered Options

### Option 1: Continue Using Synthetic Data

**Pros:**
- Fast test execution (minimal data)
- Complete control over test scenarios
- No dependency on external dataset releases

**Cons:**
- Doesn't test schema compatibility thoroughly
- Can't discover issues with real system names, coordinates, or connectivity
- Requires manual schema synchronization

### Option 2: Use Full e6c3 Dataset for Tests

**Pros:**
- Maximum realism
- Tests every system and connection

**Cons:**
- Slow test execution (10,000+ systems)
- Large git repository size if fixture is committed
- Excessive for most unit tests

### Option 3: Extract Real Subset from e6c3 (Selected)

**Pros:**
- Uses actual production data with real system names and coordinates
- Fixture size remains small (~8 systems) for fast tests
- Schema is guaranteed to match production dataset
- Can test realistic routing scenarios (multi-hop, spatial jumps)
- Extraction script can regenerate fixture if dataset schema changes

**Cons:**
- Requires additional tooling to extract and maintain fixture
- Slightly larger fixture than synthetic 3-system version

## Decision Outcome

**Chosen option**: Extract a real subset from the e6c3 dataset, specifically:

- **Anchor systems**: Nod, Brana (both have multiple gate connections)
- **Gate-connected systems**: All systems reachable via stargate from Nod or Brana (D:2NAS, G:3OA0, H:2L2S, J:35IA, Y:3R7E)
- **Spatial-only systems**: E1J-M5G (no gates, tests spatial routing)
- **Nearby systems**: All systems within 80 light-years of Brana

This selection provides:
- **8 total systems** (manageable size)
- **12 jump gates** (multi-hop routing scenarios)
- **Real coordinates** (tests spatial routing and distance calculations)
- **Real metadata** (region, constellation names from e6c3 schema)
- **Mixed connectivity** (gate-only, spatial-only, and hybrid routes)

### Positive Consequences

- Tests validate schema compatibility with actual production data
- Real system names eliminate confusion about what's being tested (Nod, Brana vs Y:170N, BetaTest)
- Spatial routing tests use authentic coordinates and distances
- Fixture generation is automated via `scripts/extract_fixture_from_dataset.py`
- Schema bugs (e.g., case sensitivity in column names) are caught by tests

### Negative Consequences

- Fixture database is slightly larger (~26 planets, 43 moons vs minimal synthetic data)
- Test assertions must account for real distances (e.g., Nod ↔ Brana is ~297 ly, not synthetic 20 meters)
- Regenerating fixture requires downloading the full e6c3 dataset (one-time setup cost)

## Implementation Notes

### Fixture Generation

The fixture is generated by `scripts/extract_fixture_from_dataset.py`:

```bash
# Download the e6c3 dataset
cargo run -p evefrontier-cli -- download --data-dir /tmp/e6c3_source

# Extract the fixture
python3 scripts/extract_fixture_from_dataset.py /tmp/e6c3_source/static_data.db docs/fixtures/minimal/static_data.db
```

The wrapper script `scripts/create_minimal_db.py` now invokes the extraction script for consistency with existing workflows.

### Dataset Pinning

We pin to the **e6c3 release** for the following reasons:

1. **Stability**: e6c3 is the first public dataset release for EVE Frontier; its schema serves as the baseline
2. **Reproducibility**: Tests must pass consistently; pinning prevents unexpected failures when CCP releases new datasets
3. **Backwards Compatibility**: If future datasets change schema, we can add detection logic while maintaining e6c3 compatibility

**When to update**: The pinned dataset should be updated when:
- CCP releases a new dataset with breaking schema changes
- New EVE Frontier features require testing additional data (e.g., new jump types, wormholes)
- A documented decision is made to migrate to a newer dataset version

The dataset version is **not** automatically updated to avoid CI failures or test instability.

### Test Migrations

All tests were updated to reference real system names:

| Synthetic Name | Real Name | Notes |
|----------------|-----------|-------|
| Y:170N | Nod | Multiple gate connections (D:2NAS, H:2L2S, J:35IA) |
| BetaTest | Brana | Connected to G:3OA0, Y:3R7E |
| AlphaTest | H:2L2S | Intermediate system for multi-hop routes |

Tests now use realistic distances and connectivity patterns extracted from the e6c3 dataset.

### Schema Compatibility Fix

Extraction revealed a schema bug: the loader expected `constellationID` / `regionID` (uppercase), but e6c3 uses `constellationId` / `regionId` (camelCase). This was fixed in `crates/evefrontier-lib/src/db.rs` to match the production schema.

## Links

- [ADR 0004: Schema Detection](0004-schema-detection.md) — Runtime schema detection strategy
- [ADR 0003: Downloader and Caching](0003-downloader-caching.md) — How datasets are downloaded and cached
- `scripts/extract_fixture_from_dataset.py` — Fixture extraction implementation
- `docs/fixtures/README.md` — Fixture documentation and usage
