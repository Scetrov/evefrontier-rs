[hooks]
pre-commit = """
set -e
echo "üîç Running pre-commit checks via Nx (serialized)..."
echo ""

# 0. Stabilize environment to avoid target dir races
export CARGO_TARGET_DIR="$PWD/target"
export NX_DAEMON=false

# 1. Format (Rust)
echo "1Ô∏è‚É£  Checking Rust formatting..."
cargo fmt --all -- --check || {
    echo "‚ùå Format check failed. Run: cargo fmt --all"
    exit 1
}
echo "   ‚úÖ Format OK"
echo ""

# 2. Build (once) ‚Äî serialize to avoid target dir races
echo "2Ô∏è‚É£  Building all projects via Nx (parallel=1)..."
pnpm nx run-many --target=build --all --parallel=1 || {
    echo "‚ùå Nx build failed"
    exit 1
}
echo "   ‚úÖ Build OK"
echo ""

# 3. Clippy (no redundant build)
echo "3Ô∏è‚É£  Running clippy via Nx (parallel=1)..."
pnpm nx run-many --target=clippy --all --parallel=1 || {
    echo "‚ùå Clippy failed"
    exit 1
}
echo "   ‚úÖ Clippy OK"
echo ""

# 4. Tests ‚Äî also serialized
echo "4Ô∏è‚É£  Running tests via Nx (parallel=1)..."
pnpm nx run-many --target=test --all --parallel=1 || {
    echo "‚ùå Tests failed"
    exit 1
}
echo "   ‚úÖ Tests OK"
echo ""

# 5. Security audit (fail on RustSec advisories, allow yanked/unmaintained warnings)
echo "5Ô∏è‚É£  Running cargo audit..."
cargo audit || {
    echo "‚ùå Security vulnerabilities detected"
    exit 1
}
echo "   ‚úÖ Audit OK"
echo ""

echo "‚úÖ All pre-commit checks passed!"
"""

[logging]
verbose = true
